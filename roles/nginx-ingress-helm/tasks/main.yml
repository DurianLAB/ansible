# tasks/main.yml

- name: 1. Ensure the Helm chart repository is configured
  ansible.builtin.debug:
    msg: "Ensure you have the 'kubernetes.core' collection installed: ansible-galaxy collection install kubernetes.core"

- name: 2. Add the NGINX Ingress Helm Repository
  kubernetes.core.helm_repository:
    name: "{{ nginx_ingress_repo_name }}"
    repo_url: "{{ nginx_ingress_repo_url }}"
    state: present

- name: 3. Deploy or Upgrade the NGINX Ingress Helm Chart
  kubernetes.core.helm:
    name: "{{ nginx_ingress_helm_release_name }}"
    chart_ref: "{{ nginx_ingress_repo_name }}/{{ nginx_ingress_chart_name }}"
    release_namespace: "{{ nginx_ingress_helm_namespace }}"
    release_state: present
    create_namespace: "{{ nginx_ingress_helm_create_namespace }}"
    # Use default({}) to ensure 'values' is an empty dict if not defined, avoiding errors
    values: "{{ nginx_ingress_helm_values | default({}) }}"
    wait: "{{ nginx_ingress_helm_wait }}"
    wait_timeout: "{{ nginx_ingress_helm_wait_timeout }}"

- name: 4. Explicitly create Namespace (Recommended for clearer k8s task reporting)
  kubernetes.core.k8s:
    name: "{{ nginx_ingress_helm_namespace }}"
    api_version: v1
    kind: Namespace
    state: present
  when: nginx_ingress_helm_create_namespace
  tags: verify_namespace